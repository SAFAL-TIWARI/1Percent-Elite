/**
 * BACKEND - GOOGLE DRIVE API INTEGRATION
 * --------------------------------------
 * Fetches real data from Google Drive.
 */

// CONFIGURATION
// Accessing the API Key from window.CONFIG (generated by setup-env.js)
const API_KEY = window.CONFIG ? window.CONFIG.GOOGLE_DRIVE_API_KEY : '';
const ROOT_FOLDER_ID = '1QSZs3pydG7zdzx3zJ6rtdPcZIhntzSWd'; // User's Folder ID

// Cache to store fetched data and avoid repeated API calls
const cache = {};

/**
 * Fetches the name and metadata of the root folder itself.
 */
async function getRootFolder() {
    if (cache[ROOT_FOLDER_ID]) return cache[ROOT_FOLDER_ID];

    try {
        if (!API_KEY) {
            throw new Error("API Key is missing. Check .env file.");
        }

        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${ROOT_FOLDER_ID}?key=${API_KEY}&fields=id,name,mimeType`);
        if (!response.ok) throw new Error('Failed to fetch root folder');

        const data = await response.json();

        const rootNode = {
            id: data.id,
            name: data.name,
            type: 'folder',
            children: [], // Will be loaded on demand
            files: [],
            loaded: false // Flag to check if children are fetched
        };

        cache[ROOT_FOLDER_ID] = rootNode;
        return rootNode;
    } catch (error) {
        console.error("API Error:", error);
        // Fallback if API fails (e.g. CORS or permissions)
        return {
            id: ROOT_FOLDER_ID,
            name: "Target Drive Folder (Offline/Error)",
            type: 'folder',
            children: [],
            files: [],
            loaded: false,
            error: true
        };
    }
}

/**
 * Fetches children (folders and files) of a specific folder.
 */
async function getFolderContents(folderId) {
    // Query: Parents contains folderId AND Not Trashed
    const query = `'${folderId}' in parents and trashed = false`;
    const fields = 'files(id, name, mimeType, size, webContentLink, webViewLink, iconLink, thumbnailLink)';
    const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&key=${API_KEY}&fields=${encodeURIComponent(fields)}&pageSize=1000`;

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Error fetching contents for ${folderId}`);

        const data = await response.json();
        console.log(`Fetched ${data.files.length} items for folder ${folderId}`);

        const folders = [];
        const files = [];

        data.files.forEach(file => {
            // Filter out the folder itself if it somehow appears (prevent infinite recursion/duplication)
            if (file.id === folderId) return;

            if (file.mimeType === 'application/vnd.google-apps.folder') {
                folders.push({
                    id: file.id,
                    name: file.name,
                    type: 'folder',
                    children: [],
                    files: [],
                    loaded: false
                });
            } else {
                // It's a file
                let type = 'unknown';
                if (file.mimeType.includes('image')) type = 'image';
                else if (file.mimeType.includes('pdf')) type = 'pdf';
                else if (file.mimeType.includes('video')) type = 'video';

                console.log(`Found file: ${file.name} (${file.mimeType}) -> Type: ${type}`);

                // Construct a direct preview URL for embedding
                const previewUrl = `https://drive.google.com/file/d/${file.id}/preview`;

                files.push({
                    id: file.id,
                    name: file.name,
                    type: type,
                    size: formatSize(file.size),
                    url: previewUrl, // Use the preview URL for the iframe
                    downloadUrl: file.webContentLink, // Keep download link for the button
                    shareUrl: file.webViewLink, // Link for sharing
                    preview: file.thumbnailLink,
                    mimeType: file.mimeType
                });
            }
        });

        console.log(`Processed: ${folders.length} folders, ${files.length} files`);

        // Sort: Folders first, then files, both alphabetical
        folders.sort((a, b) => a.name.localeCompare(b.name));
        files.sort((a, b) => a.name.localeCompare(b.name));

        return { folders, files };

    } catch (error) {
        console.error("Fetch Error:", error);
        return { folders: [], files: [] };
    }
}

// Helper to format bytes
function formatSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Export the object
export const Backend = {
    getRootFolder,
    getFolderContents
};
